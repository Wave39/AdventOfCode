//
//  Puzzle_2023_16.swift
//  AdventOfCode
//
//  Created by Brian Prescott on 12/4/23.
//  Copyright Â© 2023 Wave 39 LLC. All rights reserved.
//

import Foundation

public class Puzzle_2023_16: PuzzleBaseClass {
    public func solve() {
        let part1 = solvePart1()
        print("Part 1 solution: \(part1)")

        let part2 = solvePart2()
        print("Part 2 solution: \(part2)")
    }

    public func solvePart1() -> Int {
        solvePart1(str: Puzzle_Input.final)
    }

    public func solvePart2() -> Int {
        solvePart2(str: Puzzle_Input.final)
    }

    struct Beam : Hashable {
        var position: Point2D
        var direction: CompassDirection
    }

    private func getNextDirections(beam: Beam, grid: CharacterGrid) -> [CompassDirection] {
        let c = grid.characterAtPoint(beam.position)
        if c == "-" {
            if beam.direction.MovingVertically() {
                return [ .West, .East]
            } else {
                return [ beam.direction ]
            }
        } else if c == "|" {
            if beam.direction.MovingHorizontally() {
                return [ .North, .South ]
            } else {
                return [ beam.direction ]
            }
        } else if c == "/" {
            if beam.direction.MovingVertically() {
                return [ beam.direction.TurnRight() ]
            } else {
                return [ beam.direction.TurnLeft() ]
            }
        } else if c == "\\" {
            if beam.direction.MovingVertically() {
                return [ beam.direction.TurnLeft() ]
            } else {
                return [ beam.direction.TurnRight() ]
            }
        }

        return [ beam.direction ]
    }

    private func solve(grid: CharacterGrid, initialBeam: Beam) -> Int {
        let gridColumns = grid.width
        let gridRows = grid.height

        var beamHistory = Set<Beam>()

        func followBeam(_ beamToFollow: Beam) {
            var beamToFollow = beamToFollow
            while true {
                if beamHistory.contains(beamToFollow) {
                    return
                }

                beamHistory.insert(beamToFollow)
                let nextDirections = getNextDirections(beam: beamToFollow, grid: grid)
                if nextDirections.count == 1 && nextDirections[0] == beamToFollow.direction {
                    if let nextPosition = beamToFollow.position.moveForwardFromTopLeftOrigin(direction: beamToFollow.direction, rows: gridRows, columns: gridColumns) {
                        beamToFollow = Beam(position: nextPosition, direction: beamToFollow.direction)
                    } else {
                        // we have reached a position off the grid
                        return
                    }
                } else {
                    for direction in nextDirections {
                        if let nextPosition = beamToFollow.position.moveForwardFromTopLeftOrigin(direction: direction, rows: gridRows, columns: gridColumns) {
                            followBeam(Beam(position: nextPosition, direction: direction))
                        }
                    }

                    return
                }
            }
        }

        followBeam(initialBeam)

        var newGrid = grid
        for beam in beamHistory {
            let c = newGrid.characterAtPoint(beam.position)
            if !(c == "|" || c == "-" || c == "/" || c == "\\") {
                if c == "." {
                    let newChar: Character
                    if beam.direction == .North {
                        newChar = "^"
                    } else if beam.direction == .South {
                        newChar = "v"
                    } else if beam.direction == .West {
                        newChar = "<"
                    } else {
                        newChar = ">"
                    }

                    newGrid.setCharacterAtPoint(beam.position, newChar)
                } else {
                    newGrid.setCharacterAtPoint(beam.position, "*")
                }
            }
        }

        return Set(beamHistory.map { $0.position }).count
    }

    private func solvePart1(str: String) -> Int {
        let grid = str.parseIntoCharacterMatrix()
        let initialBeam = Beam(position: Point2D(x: 0, y: 0), direction: .East)
        return solve(grid: grid, initialBeam: initialBeam)
    }

    private func solvePart2(str: String) -> Int {
        let grid = str.parseIntoCharacterMatrix()
        var retval = 0
        for x in 0..<grid.width {
            let southBeam = Beam(position: Point2D(x: x, y: 0), direction: .South)
            retval = max(retval, solve(grid: grid, initialBeam: southBeam))
            let northBeam = Beam(position: Point2D(x: x, y: grid.height - 1), direction: .North)
            retval = max(retval, solve(grid: grid, initialBeam: northBeam))
        }

        for y in 0..<grid.height {
            let eastBeam = Beam(position: Point2D(x: 0, y: y), direction: .East)
            retval = max(retval, solve(grid: grid, initialBeam: eastBeam))
            let westBeam = Beam(position: Point2D(x: grid.width - 1, y: y), direction: .West)
            retval = max(retval, solve(grid: grid, initialBeam: westBeam))
        }

        return retval
    }
}

private class Puzzle_Input: NSObject {
    static let test = #"""
.|...\....
|.-.\.....
.....|-...
........|.
..........
.........\
..../.\\..
.-.-/..|..
.|....-|.\
..//.|....
"""#

    static let final = #"""
\....|...-...../.....|....................-./............|/.....................-........./.....-.............
\..........-.....................-......................................|....................\..../.....-.....
....\......-...../../../...\......................\.........................-.............|.............|.....
.........../..../...........|/\.............\........\.......|.........|..|../............/.........|.........
\./...\........\..........\......./....../...............................|....|........|................/.....
|-.....|............/...............|...\...|...../......../.....|............|..\..|..../.......-.........\..
........-.............||../..........|.........../..................../.|.....|\..-/......./...\...\....-.....
....................//........................./..........\.......|...|.........../......\-......-...\........
....../..........\......\.....................\................\......\..\..|.................................
.................\...............-....../........./....-./..........|..../..-..|../................\..........
.............-...............-......|.../.....-.....//.\................../..........-......-...........-.....
.........../.\.....................\............-..........|.......\..................\.......................
...............\............/.|...\........../....\.............|...........\...............|.../........\....
./..............\................-\.../\.......-....................-..............-|.............\.-.........
../....../.........|..../......\...\.\.................|......./.......|...............-.........-............
-...-............................\.............-.\........-.....|.........././-......|......-..../...|........
................-.....................|..|...\.././.............|..........................-.............-....
.......|...............................|.......................................-......../.............|-...-..
.\|............................\................|.....-.....-................................./...-..\...../..
.......\......-....\|......|........................................./...||...............\...................
.................../......../.......-......\..............|..\...........-.........-.............../..........
........................\......................../.................-........................\.....\...........
..........|......|........................|.|\...............\...|.............-...-....-............--.......
............|........../....\..........\........../..-..|...........-...\........................./..-........
.............||../..../.......................-/.......\.....\............./|..-...............|.....|........
................................|..\.........-......./...........-../-............\................\....-../..
.............-.............................|.\...............................\\...............................
..|.......-................................\.......|.......\.....................|../\..........\..........-..
......-..\..........-.................\.-..../\......./......./..-.......................\.....-........\.....
............................../.....................\.................\................|..../\.............\..
..............................-.......\.........-..........\....../............./.....-........\...-.........|
/..................\...||..|...........\...............-............\..........|./.....-.-./.............../..
.....|......./...............\.......-................-...........................................\...........
.|.................../.....\............./.....\.................-.../.......-..............\..-..............
......\........|...|...........//..........|\.\..............................-..../...-............|..........
|......\....|\......|........../.........../........-.........|.-\//................/..\....|.../........|....
.-....-......................./.........\.........-.../............................-..|........|.....|...|....
.........-..................-..........-....-....................-....-./.......................|.../......\..
..-../......................-\.....|...\........./.-...............-.................../../............|......
.-/.......-../.......-...|\...../..........-...\.......\.........-....\-................-......|........-.....
.............................\\\............-..............|........../...................-......../....../../
.....-....\....\......................-..\...............-..|...............-................-.......\......|.
..-...\.............................../.../.............................--.......-..|.|\...../...............\
......\.../...-.....|....|......\.../|...................................-................-................./.
.......-......-.../..................|../..................\..........................\-..........-\..........
.-.......\.........|....|\/./-\.-.....|..................-...................................-|...\...........
...........-........../\..................\./..........................\...../...........-...\...../..\....-..
..-.|...../|......\..\........|.............-.....|..........\...-...-../......................../.......|....
......../................/..\.......\..-...|.....\.......|\..........................-..\../..........\./.....
........\.-......|......|..........|........-...................-..\.....-./..............-.\......\..........
........|./..................\........|......................\............................./.-\....\........-.
........\.|......\................/..\....-/.\.....-.....|............................\..\.|............|...-.
...-.....-|..................|...............-./.....................\..\............|.....-..................
..........|\./.....\..................|.........|.....................-\./..\........\........................
../........\..............|....-...............................................|..........-......../..........
..\..............|...../../....................-....\.....................|........\...\\.....................
...........................-...\......\......./../..........\-...../.......................-...........\......
-.|........................../.....|...............\..........-.............\...-................-.......-....
/../.........\........./......-.../..-..................-.......................\............--...............
\...............|......-..../......................................-........./|......................\|....../
.....\.......................................-...................-.../...........\.......|../.............|...
....-....||......\..\.......-.........-......../..../............\..................................-.........
...-..|.......\..\..|..........-../-..........\............../...............|..../........./....../.......|./
.......................\.......././.............\..................-..........|................../....|.......
-.|.....................\\.........../......./.|................/................|./......./....-.............
......-...............-....-................|./\..\-/...../......../....-....\....|.-.................../...\.
...............\......-...\...\....-....-/....................\./....../..................-|........\./...../.
.\......................./..\.........\.........|............|.......-../..\.-..|.-..........................|
..|../.....................|/......................./......../.../.........-.../.|./.|.-..............|....-..
...-.-/............/............|..........|....../\...\./.....|..................|....\............/.........
.....|........./.........\.............../......./../../...................|.......//.......\..\..........\...
......./.............\...........\.\..............................................\...................|.......
...............-|...../..-............................\.....-.............../\.........-....................\.
.........-.....................-...\...................-..../.................||....\.........-.......-..-....
.|../..\...\......|..\./.........\..............|..\/......../...............-..-....................-.....\..
..................|........\.-.....|.......\............../................................/...-....|...../...
...........-......./........-...--........\.../..-...../.|............|......./...............|....../\......\
.../.....\...................-..../....................................-......................|.............-.
.\.....|....-.....|.....-...................................................|../....\..................\.....-
....-........../\......../.......-....\............................./-.............-..........................
....\.........-........./......../....|..............\........\../.................\.|...............\........
.........-..............|./............-.......................\.......\......-\......\......../..............
-.|...|./-..........\..........-...-............|...-......................\..\.............................-.
............/......................../.........................................\/..........|.....|.-........|/
....../..|./..././.....-......................../....|................../..|........-.....................|./.
.......................\....................../......./......\/........\......./....../\|.....\...............
\...........\/.|../..................../...............\\...\..../..................\......./.................
.../................/...............\./....-./........../........./\..-.................................\.....
........-.......-...........\........-.......\............|............|.....-........|..|..../...............
.............|...|............/....\............................................-..\......./.../..........\...
...................../-..|...........-................../.\...|.....\.....|/.................|................
..|................\.....-...........|.\............-.........|....../...................\......-.|.......\...
........\......../.....-...\..\...........\........|/.............../......|.......|.\..|........|............
..........\.....................-..|/.....\............-............../.......................|./........\....
.......\........|...........\......\.......-..-.....|............./......|\..............................|....
.........\.......................-............-/.................................\............|...............
.........\................/.............................../..........\................-../../......|......-...
....\...-./...............\...............|.....\|....|/...............-...........................-..........
.|.......\.......-............./.......\............./....................|......|../......-...........\......
.....\.....-.....\...\................/......\...\../.\...\....\-....-././...............................|./..
.....................-.\.\.........../......./...-......./-.........................\.......|../....\..|..../.
|..\......./-......-...../..-....../.................../..-.....................-..../...........\...../......
......................................./................|....\/....\............/....../......................
......................../..........|........-............|.........................|.\................|....../
-.............-...|...........-....-..-.|\.......|......\..........-......|-...-......\.......................
...........\.\\.../.................\..........\..-......-......|.-............................-.||...|....../
....|................--........|.|..........|......\.............................................-............
.-..|................/../..-.........................../...../.....\.../....-.....\-..................../.....
............./|..........................\...................................-..-..........|....\..|..........
....|...../........./.-....-..................../.........../....................-................\./.........
"""#
}
